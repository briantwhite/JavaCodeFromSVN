/* this is the main class - the genex application * written by Brian White 2004 *  brian.white@umb.edu *   This program is free software; you can redistribute it and/or * modify it under the terms of the GNU General Public License * as published by the Free Software Foundation; either version 2 * of the License, or (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. **/ import java.awt.*;import java.awt.event.*;import javax.swing.*;import javax.swing.event.*;import javax.swing.text.html.*;import java.net.*;public class GenexApplet extends JApplet {	static JTextPane textPane = new JTextPane();	static JLabel infoLabel = new JLabel("Selected Base = ");	static JButton resetButton = new JButton("Reset DNA Sequence");	static JButton newSequenceButton = new JButton("Enter New DNA Sequence");		static JButton addCaptionButton = new JButton("Enter a Caption");	static JButton pageSetupButton = new JButton("Page Setup");	static JButton printButton = new JButton("Print");	static JButton helpButton = new JButton("Help");	static JButton aboutButton = new JButton("About");	static String defaultDNA = new String("CAAGGCTATAACCGAGATTGATGCCTTGTGCG" 	                                    + "ATAAGGTGTGTCCCCCCCCAAAGTGTCGGATG"	                                    + "TCGAGTGCGCGTGCAAAAAAAAACAAAGGCGA"	                                    + "GGACCTTAAGAAGGTGTGAGGGGGCGCTCGAT");    static String promoterSequence = "TATAA";    static String terminatorSequence = "GGGGG";    static String intronStartSequence = "GUGCG";    static String intronEndSequence = "CAAAG";    static String polyATail = "AAAAAAAAAAAAA";	                                        	static String DNA = defaultDNA;	static int headerLength;        //length (as actually displayed) of the text 	                                // & labels before the start of the top DNA strand	static int DNASequenceLength = defaultDNA.length();		static String caption;         //the caption at the bottom of the frame		static String previousProteinString;  //the last protein sequence displayed		static int caretPosition = 0;  //the number of the selected DNA base		static DocumentRenderer docRenderer;  // for printing		static boolean allowPrinting = false;     //parameter fro allowing printing	                                     //if false, it will not bother you by asking 	                                     // if you want to allow printing	                                     			public void init() {		    //get params if present	    String inputDNAString = getParameter("DNA_SEQUENCE");	    if (inputDNAString != null) {	        defaultDNA = inputDNAString;	        DNA = inputDNAString;	    }	    	    String inputPromoterString = getParameter("PROMOTER");	    if (inputPromoterString != null) {	        promoterSequence = inputPromoterString;	    }	    	    String inputTerminatorString = getParameter("TERMINATOR");	    if (inputTerminatorString != null) {	        terminatorSequence = inputTerminatorString;	    }	    	    String inputIntronStartString = getParameter("INTRON_START");	    if (inputIntronStartString != null) {	        intronStartSequence = inputIntronStartString;	    }	    	    String inputIntronEndString = getParameter("INTRON_END");	    if (inputIntronEndString != null) {	        intronEndSequence = inputIntronEndString;	    }	    	    String inputPolyAString = getParameter("POLY_A_TAIL");	    if (inputPolyAString != null) {	        polyATail = inputPolyAString;	    }	    	    String inputPrintingString = getParameter("PRINTING");	    if (inputPrintingString != null) {	    	    allowPrinting = true;	    }	    	    //if it's a prokaryote, no poly A tail	    if (intronStartSequence.equals("none") || intronEndSequence.equals("none")) {	        polyATail = "";	    }		    JScrollPane scrollPane = new JScrollPane(textPane);	    JPanel sequencePanel = new JPanel();	    JPanel printPanel = new JPanel();	    	    if (allowPrinting) {	        docRenderer = new DocumentRenderer();	    }	    	    sequencePanel.add(resetButton);	    sequencePanel.add(newSequenceButton);	    sequencePanel.add(infoLabel);	    	    if (allowPrinting) {	        printPanel.add(addCaptionButton);	        printPanel.add(pageSetupButton);	        printPanel.add(printButton);	    }	    printPanel.add(helpButton);	    printPanel.add(aboutButton);	    getContentPane().add(printPanel, BorderLayout.NORTH);	    getContentPane().add(sequencePanel, BorderLayout.SOUTH);	    getContentPane().add(scrollPane, BorderLayout.CENTER);	 	       	    textPane.setContentType("text/html");	    textPane.setDragEnabled(false);	    	    addCaptionButton.setToolTipText("Add a descriptive caption to the bottom of the page.");        caption = "";	    pageSetupButton.setToolTipText("Set up the page for printing.");	    printButton.setToolTipText("Print the page.");	    helpButton.setToolTipText("Open a window with help info.");	    	    resetButton.setToolTipText("Restore the original DNA Sequence");	    newSequenceButton.setToolTipText("Enter an entirely new DNA sequence");	    	    caption = new String("");	    previousProteinString = new String("");	    	    //display the default gene	    VisibleGene currentGene = expressGene(defaultDNA, -1);	    textPane.setText(currentGene.getHTML() + caption + "</pre></body></html>");	    headerLength = currentGene.getGene().getHeaderLength();	    DNASequenceLength = currentGene.getGene().getDNASequenceLength();        previousProteinString = currentGene.getGene().getProteinString();	    	    //display the gene with a selected base        textPane.addCaretListener(new CaretListener() {            public void caretUpdate(CaretEvent e) {                int dot = e.getDot();                int clickSite = dot - headerLength;                if ((clickSite >= 0) && (clickSite <= DNASequenceLength)) {                    infoLabel.setText("Selected Base = " + String.valueOf(clickSite));                    VisibleGene vg = expressGene(DNA, clickSite);                    textPane.setText(vg.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                    DNASequenceLength = vg.getGene().getDNASequenceLength();                    caretPosition = clickSite;                    headerLength = vg.getGene().getHeaderLength();                }  else {                    if (textPane.getCaretPosition() !=0) {                        textPane.setCaretPosition(0);                    }                }                            }        });                //allow editing of the gene        //  AGCT inserts DNA        //  agct replaces DNA        //  DELETE deletes DNA        textPane.addKeyListener(new KeyListener() {            public void keyTyped(KeyEvent e) {               String keyTyped = String.valueOf(e.getKeyChar());                if (keyTyped.equals("A")                   || keyTyped.equals("G")                   || keyTyped.equals("C")                   || keyTyped.equals("T") ) {                    StringBuffer workingDNAbuffer = new StringBuffer(DNA);                    workingDNAbuffer.insert(caretPosition, keyTyped);                    DNA = workingDNAbuffer.toString();                    caretPosition++;                    infoLabel.setText("Selected Base = " + String.valueOf(caretPosition));                    VisibleGene vg = expressGene(DNA, caretPosition);                    textPane.setText(vg.getHTML()                        + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                    previousProteinString = vg.getGene().getProteinString();                    DNASequenceLength = vg.getGene().getDNASequenceLength();                    headerLength = vg.getGene().getHeaderLength() + 1;                     //need the +1 otherwise, when you click on a base after moving + or -                    // the selected base is n+1 - why??                            }                if (keyTyped.equals("a")                   || keyTyped.equals("g")                   || keyTyped.equals("c")                   || keyTyped.equals("t") ) {                    StringBuffer workingDNAbuffer = new StringBuffer(DNA);                    workingDNAbuffer.replace(caretPosition,                                              caretPosition + 1,                                             keyTyped.toUpperCase());                    DNA = workingDNAbuffer.toString();                    infoLabel.setText("Selected Base = " + String.valueOf(caretPosition));                    VisibleGene vg = expressGene(DNA, caretPosition);                    textPane.setText(vg.getHTML()                        + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                    previousProteinString = vg.getGene().getProteinString();                    DNASequenceLength = vg.getGene().getDNASequenceLength();                    headerLength = vg.getGene().getHeaderLength() + 1;                     //need the +1 otherwise, when you click on a base after moving + or -                    // the selected base is n+1 - why??                            }                                if (e.getKeyChar() == '\b') {                    StringBuffer workingDNAbuffer = new StringBuffer(DNA);                    workingDNAbuffer.deleteCharAt(caretPosition);                    DNA = workingDNAbuffer.toString();                    if (caretPosition >= 0) {                        caretPosition--;                    }                    infoLabel.setText(String.valueOf(caretPosition));                    VisibleGene vg = expressGene(DNA, caretPosition);                    textPane.setText(vg.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                    previousProteinString = vg.getGene().getProteinString();                    DNASequenceLength = vg.getGene().getDNASequenceLength();                    headerLength = vg.getGene().getHeaderLength();                }                                if (keyTyped.equals("+") || keyTyped.equals("-")) {                    if (keyTyped.equals("+")) {                        caretPosition++;                        if (caretPosition > (DNA.length() - 1)) {                            caretPosition = DNA.length() - 1;                        }                    } else {                        caretPosition--;                        if (caretPosition < 0) {                            caretPosition = 0;                        }                    }                    infoLabel.setText(String.valueOf(caretPosition));                    VisibleGene vg = expressGene(DNA, caretPosition);                    textPane.setText(vg.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                    previousProteinString = vg.getGene().getProteinString();                    DNASequenceLength = vg.getGene().getDNASequenceLength();                    headerLength = vg.getGene().getHeaderLength() + 1;                           //need the +1 otherwise, when you click on a base after moving + or -                    // the selected base is n+1 - why??                            }            }                        public void keyPressed(KeyEvent e) {            }                        public void keyReleased(KeyEvent e) {            }        });                //display the default DNA        resetButton.addActionListener(new ActionListener() {            public void actionPerformed(ActionEvent e) {                DNA = defaultDNA;        	    VisibleGene currentGene = expressGene(DNA, -1);        	    textPane.setText(currentGene.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                previousProteinString = currentGene.getGene().getProteinString();        	    headerLength = currentGene.getGene().getHeaderLength();        	    DNASequenceLength = currentGene.getGene().getDNASequenceLength();         	    headerLength = currentGene.getGene().getHeaderLength();                       }        });                //allow the user to enter a sequence manually        newSequenceButton.addActionListener(new ActionListener() {            public void actionPerformed(ActionEvent e) {                String newDNA = (String)JOptionPane.showInputDialog(null,                                         "Enter new DNA Sequence",                                         "New DNA Sequence",                                         JOptionPane.PLAIN_MESSAGE,                                         null, null, DNA);                newDNA = newDNA.toUpperCase();                newDNA = newDNA.replaceAll("[^AGCT]","");                DNA = newDNA;        	    VisibleGene currentGene = expressGene(DNA, -1);        	    textPane.setText(currentGene.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");                previousProteinString = currentGene.getGene().getProteinString();        	    headerLength = currentGene.getGene().getHeaderLength();        	    DNASequenceLength = currentGene.getGene().getDNASequenceLength();          	    headerLength = currentGene.getGene().getHeaderLength();                      }        });	    	    //allow the user to add a caption at the bottom of the textPane        // if printing is allowed        if (allowPrinting) {	        addCaptionButton.addActionListener(new ActionListener() {	            public void actionPerformed(ActionEvent e) {	                caption = (String)JOptionPane.showInputDialog(null,	                                     "Enter a Caption for this page.",	                                     "Caption:",	                                     JOptionPane.PLAIN_MESSAGE,	                                     null, null, caption);        	        VisibleGene currentGene = expressGene(DNA, -1);        	        textPane.setText(currentGene.getHTML()                         + "<font color=blue>" + previousProteinString                         + "</font></pre><br><br><br><font size=+1>" + caption                         + "</font></body></html>");        	        headerLength = currentGene.getGene().getHeaderLength();        	        DNASequenceLength = currentGene.getGene().getDNASequenceLength();         	        headerLength = currentGene.getGene().getHeaderLength();           	            	            }	        });        }	    //page setup for printing, if allowed        if (allowPrinting) {	        pageSetupButton.addActionListener(new ActionListener() {	            public void actionPerformed(ActionEvent e) {	               docRenderer.pageDialog();	            }	        });        }	            //print the textPane, if allowed        if (allowPrinting) {	        printButton.addActionListener(new ActionListener() {	            public void actionPerformed(ActionEvent e) {	                docRenderer.setScaleWidthToFit(true);	                HTMLDocument htdoc = (HTMLDocument)textPane.getDocument();	                docRenderer.print(htdoc);	            }	        });        }                //display the help info	    helpButton.addActionListener(new ActionListener() {	        public void actionPerformed(ActionEvent e) {	            URL url = Genex.class.getResource("fig1.gif");	            ImageIcon pic = new ImageIcon(url);	            JOptionPane.showMessageDialog(null,	                              "<html><body>"	                  + "Click the top strand of DNA to select a base.<br>"	                  + "Move <u>right</u> with +<br>"	                  + "Move <u>left</u> with -<br>"	                  + "<u>Delete</u> a base with the Delete Key.<br>"	                  + "<u>Insert</u> a base with AGCT.<br>"	                  + "<u>Replace</u> a base with agct.<br>"	                  + "</body></html>",	                              "Genex Help",	                              JOptionPane.PLAIN_MESSAGE,	                              pic);	        }	    });        //display the about info	    aboutButton.addActionListener(new ActionListener() {	        public void actionPerformed(ActionEvent e) {	            JOptionPane.showMessageDialog(null,	                              "<html><body>"	                  + "<center>Gene Explorer Version 1.0.1<br>"	                  + "<br>"	                  + "Brian White (2004)<br>"	                  + "brian.white@umb.edu"	                  + "</body></html>",	                              "About Genex",	                              JOptionPane.PLAIN_MESSAGE);	        }	    });	}		static VisibleGene expressGene(String currentDNA, int selectedDNABase) {        	// set up the gene for transcription, etc.	    Gene currentGene = new Gene(currentDNA, promoterSequence, terminatorSequence,                                     intronStartSequence, intronEndSequence, polyATail);	        //process the gene before displaying it        currentGene.transcribe();        currentGene.process();        currentGene.translate();//        currentGene.showItAll();        //generate the html & return it        return new VisibleGene(currentGene.generateHTML(selectedDNABase), currentGene);    }    }