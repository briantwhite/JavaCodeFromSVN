Features Log:
History List:
- double-click to get menu of options
	to upper
	to lower
	add notes
	delete
	
Greenhouse in general:
	- can change names of .organism files in greenhouse folder
		next time they are loaded, the name in the greenhouse
		will match the filename (that way, you can re-name
		them after you've saved them).

Molecular Biology:
	- double-click on greenhouse member loads it into 
		gene expression panels
	- "save" folds proteins as necessary if they aren't already 
		before saving


Biochemistry:
	- double-click on greenhouse member loads it into
		folding windows
	- can't save proteins to greenhouse (DNA siquence is unclear)

Genetics:
	- single click an organism in greenhouse or genetics window
	    to toggle selection
	- mutate hits BOTH copies once and only once
		(3/4 chance of mutation; 1/4 chance that it is "changed" to same

----------------------------------------------------------
Work Log:

9/25/06
started from scratch
added in protex and genex
had to modify them so they made JPanels rather than JFrames
  since you can't add a JFrame to a JTabbedPane
  
9/27/06
worked on genex
- made it a 2-panel version
- parallel structure to protex
- nuked out printing, and black-and-white stuff
- nuked help and about

9/28/06 
working on genex
- trying to get folding button to work

12/6/06
added stuff for aligning sequences
got code from http://www.dina.dk/~sestoft/bsa/bsapplet.html
it was in one big file & therefore hard to use
broke into individual class files
use them like new NM(new BloSum50(), 8, seq1, seq2).domatch(new Output(), "message");

3/1?/07
added class molGenexp/CustomListSelectionModel
start of trying to make selections work better
this one just reports out the updating events

3/14/07
- made Green-1 (homozygous green) organism

in case organism gets messed up, the DNA sequences are:
 Green-1
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGGCGGCAGTAGTAGGGGGCGT
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGGCGGCAGTAGTAGGGGGCGT
 
 Green
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGTCGGCAGTAGTAGGGGGCGT
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTGGTGTCGGCAGTAGTAGGGGGCGT
 
 Red
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTTCTGTCGGCAGTAGTAGGGGGCGT
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTTCTGTCGGCAGTAGTAGGGGGCGT
 
 White
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGGTCTGTCGGCAGTAGTAGGGGGCGT
 CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGGTCTGTCGGCAGTAGTAGGGGGCGT
 
 also altered CustomListSelectionModel
 - commented out the print statements

***SAVED AS VERSION 0.8
-this version works
	- it has the ugly selection thing
	- it does not print debug messages to the console
 
- working on improved genetics selection management
-removed "location" integer from Organism (not needed since now in OrgAndLoc class)
	had to do lots of fixes
- got the genetics selection to work
- the double-click in genex & protex makes a HUGE list of errors...

3/16/07
- got it to work
 you need to make a new CustomListSelectionModel when switching panes
 otherwise you get the infininte loop of calls to setSelectedIndexes()
 - this is because the old object keeps some state info that needs to be cleared out
 	therefore, making a new one is the best way to clear it out

- fixed it so that any changes to greenhouse clears oal1 and oal2

3/27/07
bug: paste a sequence into genex & express it
	it folds the "previous" sequence, not the new one.

- fixed in GeneExpressionWindow - in load new sequence button listener
	use the instance variable currentGene (was a local variable)

used this to make the greenhouse of organisms shown on 3/14/07

bug: after adding to greenhouse from genex, the "add" button is disabled
fixed

6/15/07
bug: when resized, the aa table in protex can shrink vertically
fixed: added box layout and rigid vertical area

major refactoring
made superclasses of major types:

- Workbench = GeneticsWorkbench, protex, and genex 
	the big thing with both panels and the controls

- Workpanel = an individual window for a tray, folding one protein, one gene

- HistoryList = a generic history list

- HistListItem = a generic member of history list (eg a Tray)

implemented these for genetics first.

got proteins to work - but it broke 
	- the organisms in the greenhouse (need to remake)
	- the comparator (check the name of the class it looks for)

6/17/07
continued working
had to remake greenhouse
- working on comparator bug...
need to put in mge and SequenceComparatorMenuItemListener
to look for class biochem.BiochemistryWorkbench

now OK

implement refactoring and double-click hist list items for genex

NOTE!!! - the DNA hist list used to allow you to double-click to show the folded protein
now, we'll need to nuke this feature or make a special menu item....

this was the code:
			public void mouseClicked(MouseEvent e) {
				if (e.getClickCount() == 2) {
					ExpressedGene eg = 
						(ExpressedGene)getSelectedValue();
					FoldedPolypeptide fp = eg.getFoldedPolypeptide();
					JLabel colorChipForDialog = new JLabel("     ");
					colorChipForDialog.setOpaque(true);
					colorChipForDialog.setBackground(fp.getColor());
					colorChipForDialog.setBorder(new LineBorder(Color.BLACK));

					Object[] options = {"OK",
							new JLabel("Color:"),
							colorChipForDialog
					};
					JOptionPane.showOptionDialog(
							mge,
							"",
							"Protein Structure",
							JOptionPane.YES_OPTION,
							JOptionPane.INFORMATION_MESSAGE,
							fp.getFullSizePic(),
							options,
							options[0]);
				}
			}

6/19/07
- tried to fix genex bug: when you select a base off screen, it scrools back to show the first base
 scrollRectToVisible should work, but it doesn't...
 
 - refactoring:
 	- fix references to genex and protex to MolBiolWorkbench and BiochemistryWorkbench
 
 - fixed the HistListPopupMenu for mol bio to show the protein structure
 
 added a new allele: a white that produces no protein.
 this makes a new greenhouse set (red is not a heterozygote of red and white-null)
 
 the sequences are:
 Green-1
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGGCGGCAGTAGTAGGGGGCGT
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGGCGGCAGTAGTAGGGGGCGT
 
 Green-2
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTACTGTCGGCAGTAGTAGGGGGCGT
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTGGTGTCGGCAGTAGTAGGGGGCGT
 
 Red
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTTCTGTCGGCAGTAGTAGGGGGCGT
CAGCTATGACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGTTCTGTCGGCAGTAGTAGGGGGCGT
 
 White
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGGTCTGTCGGCAGTAGTAGGGGGCGT
CAGCTATAACCGAGATTGATGTCTAGTGCGATAAGCCCCAAAGATCGGCACATTTTGTGCGCTATACAAAGGTTAGTGGTCTGTCGGCAGTAGTAGGGGGCGT
 
 
changed orange to be 255,100,0 - to be more conspicuously different from yellow and red

called it version 1.1

6/20/07
BIG TROUBLE
while the program opens the greenhouse fine in eclipse
the "serial versions" don't match when you run it from the command line or double-clicking the jar
the jvm's are different....
how to fix this?

tried removing the serialVersionUID from Organism.java (that's the only place it appears)
NG

try getting latest java...
NG

note that the errors are always the same - even when I change Organism.java
java.io.InvalidClassException: javax.swing.ImageIcon$AccessibleImageIcon; local class incompatible: 
   stream classdesc serialVersionUID = -3994512798706967451, local class serialVersionUID = -1903458698681874148
   
forget it
just save Organisms as DNA seqences 
	one per line
	it will ignore any line that doesn't contain all AGCT
read them in and assemble them as they come in
have a progress bar for this.

this should be version 1.2
set version # and made a version in CVS

made mac and pc versions
in mac version, used JarBundler to make a .app
	right-click the .app
	"view contents"
	use bbedit to open Info.plist
	add:
		<key>CFBundleIdentifier</key>
        <string>edu.umb.MGX</string>
	now, this will act like a real application in the "restricted finder" list of applications

7/6/07
apply fixes from protex
1) improved speed
put in CVS

2) changed color coding of amino acids in biochem workshop

made version 1.3
put in cvs
tagged as version 1.3

set so that the greenhouse won't get wider if you stretch the whole thing

version 1.3.1
put in cvs
tagged as version 1.3.1

10/5/07
- it was crashing when people had more than 60 trays in the Genetics Workshop
due to OutOfMemoryError
(more info in notebook)
In Organism.java, was creating these massive int[] for each BufferedImage of the flower icon
could not get them garbage collected
- they were 500kb per tray!
so made a static iconCache in Organism to keep the icons we've made so far
  (indexed by color.toString())
now there are no more of these massive arrays
should be OK
try making many trays
made 100 & it was OK
tagged as version 1.3.2

10/18/07
working on new bug
if you make a lot of mutants, it runs out of memory
it's because of all the buffered images
therefore, when making mutants, don't make the images
- save the new organisms with the images as NULL
- if you open them in biochemworkbench, then draw the picx as necessary

started refactoring GridCanvas's paint() to allow for multiple entry points

10/19/07
- working on bug - extra scrolbar appears in BiochWBench when screen is small
 - OutputPalette already has a scroller so none is needed in BiochemWorkPanel
- fixed

- added genetic code table to MoBoworkbench

10/20/07
- working on mutant out-of-memory thing
need to get rid of the full-scale image when not needed
	biochem - not needed since it already re-draws protein from Grid when loading
	mobo - only need this re-draw when looking at protein big pic
start by deleteing the BigPic & set/get methods from FoldedPolypeptide
  (just save the thumbnail & the Grid)
  then clean up the resulting mess
  	(also, when getting images from ProteinImageFactory, 
  	  explicitly set images = null when done)
  	BiochemWorkpanel
  	MoBoWorkbench
  	MoBoWorkpanel
  	MutantGenerator
  	GreenhouseLoader
  	others..
 seems to work (10 cages of mutants are OK)
 
 with 10 mutant cages
          percent          live          alloc'ed  stack class
 rank   self  accum     bytes objs     bytes  objs trace name
    1 16.11% 16.11%   5636144   19  38716128   148 322916 int[]			**FULL SIZE
    2 15.56% 31.67%   5443664   19  39463808   148 323522 int[]			**FULL SIZE
    3  9.42% 41.09%   3296288  148   3296288   148 322962 int[]			**THUMB
    4  9.13% 50.22%   3193528  148   3193528   148 323562 int[]			**THUMB
    5  7.01% 57.23%   2453088 102212   2453088 102212 322610 biochem.GridPoint
    6  7.00% 64.23%   2449248 102052   2449248 102052 323426 biochem.GridPoint
    
TRACE 322916:
	java.awt.image.DataBufferInt.<init>(DataBufferInt.java:41)
	java.awt.image.Raster.createPackedRaster(Raster.java:458)
	java.awt.image.DirectColorModel.createCompatibleWritableRaster(DirectColorModel.java:1015)
	java.awt.image.BufferedImage.<init>(BufferedImage.java:317)
	molGenExp.ProteinImageFactory.generateImages(ProteinImageFactory.java:21)
	genetics.MutantGenerator.mutateGene(MutantGenerator.java:153)
	genetics.MutantGenerator.run(MutantGenerator.java:70)
	java.lang.Thread.run(Thread.java:613)
**FULL SIZE PIC

TRACE 323522:
	java.awt.image.DataBufferInt.<init>(DataBufferInt.java:41)
	java.awt.image.Raster.createPackedRaster(Raster.java:458)
	java.awt.image.DirectColorModel.createCompatibleWritableRaster(DirectColorModel.java:1015)
	java.awt.image.BufferedImage.<init>(BufferedImage.java:317)
	molGenExp.ProteinImageFactory.generateImages(ProteinImageFactory.java:21)
	genetics.MutantGenerator.mutateGene(MutantGenerator.java:153)
	genetics.MutantGenerator.run(MutantGenerator.java:71)
	java.lang.Thread.run(Thread.java:613)
*** FULL SIZE PIC

TRACE 322962:
	java.awt.image.DataBufferInt.<init>(DataBufferInt.java:41)
	java.awt.image.Raster.createPackedRaster(Raster.java:458)
	java.awt.image.DirectColorModel.createCompatibleWritableRaster(DirectColorModel.java:1015)
	java.awt.image.BufferedImage.<init>(BufferedImage.java:317)
	molGenExp.ProteinImageFactory.generateImages(ProteinImageFactory.java:49)
	genetics.MutantGenerator.mutateGene(MutantGenerator.java:153)
	genetics.MutantGenerator.run(MutantGenerator.java:70)
	java.lang.Thread.run(Thread.java:613)
*** THUMB

TRACE 323562:
	java.awt.image.DataBufferInt.<init>(DataBufferInt.java:41)
	java.awt.image.Raster.createPackedRaster(Raster.java:458)
	java.awt.image.DirectColorModel.createCompatibleWritableRaster(DirectColorModel.java:1015)
	java.awt.image.BufferedImage.<init>(BufferedImage.java:317)
	molGenExp.ProteinImageFactory.generateImages(ProteinImageFactory.java:49)
	genetics.MutantGenerator.mutateGene(MutantGenerator.java:153)
	genetics.MutantGenerator.run(MutantGenerator.java:71)
	java.lang.Thread.run(Thread.java:613)
***THUMB

probably OK - it made a lot of big pics (roughly as many 2x as the & of mutants) 
but all but 19 were nuked
	where did the 19 come from? (not gc'd yet?)

see what #s look like with 5 trays of mutants
10 + 13 + 14 + 17 + 19 = 73 mutants

          percent          live          alloc'ed  stack class
 rank   self  accum     bytes objs     bytes  objs trace name
    1 16.08% 16.08%   3105920   10  20413488    73 323501 int[]
    2 14.66% 30.74%   2831184    9  20294288    73 322894 int[]
    3  8.15% 38.89%   1574208   73   1574208    73 322940 int[]
    4  8.15% 47.04%   1573088   73   1573088    73 323541 int[]
    5  6.83% 53.87%   1319064 54961   1319064 54961 323405 biochem.GridPoint

looks like it's OK
it made 73x2 big pics, all but 19 of which were nuked
	(strange, this is ~1/2 of when it was 10 trays... )
but it takes MUCH less memory.

still strange - why does it keep some around?
WHATEVER
this is still MUCH better than before (see notebook)

version 1.3.3 (tagged)
 
10/24/07
- it wasn't seeing the genetic code table image
- fixed the jar access stuff
tagged as version 1.3.4

2/7/08
preparing to add evolution

1) clean up some useless crap
	- ppID in polypeptide - not needed
	- move colorModel up to a static final in MolGenExp
		requires lots of changes (but eliminates silly passing around)
	- move StandardTable up to static final in MolGen Exp
		ditto

2) move all amino acid painting code to one place - in AminoAcid
	steal code from FoldingServer & modify
	
3) Moved protein coloring algorithm into ColorModel so its all in one place

2/10/08
4) fixed Polypeptide to output a proteinString
	aa:direction:aa:direction etc.

5) edited PolypeptideFactory
	- remove useless ppID
	- move AminoAcidTable up to static field in MolGenExp
	- changed createSOlution to createFromProteinString - to make a protein from
		a protein string (see (4))

6) Made a FoldedProteinArchive
	- should access it in FoldingManager's fold(Arrtibutes attrib) method
	
2/12/08
7) got FoldedProteinArchive working
	- can get proteins in/out

needed to fix random update bug 
	background colors of hist list items not showing up
		need to button.setOpaque(true)
		now ok

2/17/08
got it to save FoldedProteinArchive to a zip file in the greenhouse on quitting
	(close window or File-->Quit)
	apple-q requires adding stuff from com.apple.eawt that was too much of a pain to add
	see http://lists.apple.com/archives/Java-dev/2004/Sep/msg00195.html
got it to read in the archive zip file

had to fix 2 strange bugs
it'd freeze when making mutants
	- if it found a 0 aa protein in the archive, HexGrid's constructor had a fit
		so made it skip out of 0 aas
	- the protein coloring routine sometimes returned null
		made the default be white
now OK

2/22/08
added features
- it warns you (instead of error) that there's nothing in the gene pool because you
	set the fitnesses to zero
- it lets you load the world with more than one organism (it randomly places all you select)
- clear selection in World when you switch into Evolution mode
- added mutation freqs dialog
	now can run without mutation

2/23/08
working on preferences and preferences panes
working on moving global defaults
working on moving generally-used methods (express, fold, etc) to MGEUtilities

got it working
moved gene expression to one place
working on doing this with protein
made fold take any string as an arg and automoatically figure out the right way to parse it

2/24/08
got server connection working
benchmarking:
- 10x10 world
- load all with green1
- all mut rates .01
- all fitnesses 5
- don't save archive between runs
run 10 generations (when "Generation 10" appears in window)
	- local folding: 5:40, 5:12, 4:26, 3:47
	- server folding: 1:40, 1:33, 1:51, 1:59
therefore 2-3 times faster with server
try with bigger world to see if a bigger factor

- 20x20 world
	- local 20:23
	- server 4:35
  looks even better
  
- 50x50 world
	-local: 1hr 52 mins only @ gen 8
		had a null pointer exception at BruteForceFolder.recurse(BruteForceFolder.java:125)
	- server failed - couldn't find it in the archive
		probably, in doing request to fold 1300+ sequences something got lost

3/16/08
added preferences to set world size without recompiling

3/18/08
moved all progress bars to bottom of main panel - modeless feedback

fixed bug in evolution
	a saved org wouldn't load into biochem (null pointer)
		because aaseq was MetTrpArg (no spaces)
	so used polypeptide factory's parsestringtoAAs method
	now AOK

5/21/08
renamed to Aipotu 0.8
turned off the folding server - not much speed improvement
	GlobalDefaults.foldingServerEnabled controls this

need to make buttons behave properly
can't access any menus or the Add.. button when running an evolution run

bug fixes
- could only save one organism from evolution world
  after saved, the Add.. button was disabled
  modified MGX's updateGeneticsButtonStatus
  
speed up mutation by not creating a string & doing substring every time
	just make String[4] AGCT to do it
	
allowed organism names to include <space>

made dumpWorld - saves world contents to csv file.

5/22/08
made loadWorld - loads from world file

want to have it use both processors to run faster
need to benchmark again (since fixing the mutation code)
- on laptop 10.5.2; 3Gb ram; 2.33ghz intel core duo
- run from Eclipse
- nothing else running
- 10x10 world
- load all with green1
- all mut rates .005
- all fitnesses 5
- don't save archive between runs
run 10 generations (when "Generation 10" appears in window)
- mins: 4:23  

5/24/08
fixed bug in World - could select "cells" outside of world.

resume benchmarking as 5/22
- mins 3:37, 4:40

to use both processors
1) find all sequences to be folded - put in object SequencesToBeFolded
2) for n processors, use n threads, each of which draws sequences from the
   Seqs2BFolded in a synchronized method
3) progress is total - (# left in Seqs2BFolded)
4) when the Seq2BFolded is empty; all done

will need to rearrange 
- no more Evolver threads; have ProtenFolder threads that draw from Seqs2BFolded
- keep Evolver, but don't make threads of it.

probably should use a BlockingQueue and a ThreadPool

5/26/08
fixed bug in setting save pix to directory preference - it would add a filename
and make it un savable
now, if the filechooser returns something other than a directory, the
parent directory is used.

made it version 0.9

got it to save images of the workpanels to the clipboard!
but - in evolution, the slider scales show up BUT NOT THE SLIDER thingy!
maybe use spinners - they'll take up less space anyway...

5/27/08
set it to use spinners
also added population count labels - to show # of each color
got counting to work!

5/28/08
set evolution table labels to bold underlined

now, try to use threadpool to use both processors
will need some serious rearrangement

when making parallel threads, the singleton FoldingManager gets really
  messed up - two threads using the same manager
so made it a regular class
	- nuke getInstance method
	- look for compilation errors & replace with new FoldingManager()
		BiochemWorkPanel
		ThinOrganism
		MolBiolWorkpanel
		Mutator
		ProteinUtilities

all other workpanels seem OK
but evolution locks up - requires force quit.

got it to work - it uses both procesors, BUT gui is unresponsive

5/29/08
put evolver in its own Thread
now works - uses both processors
but:
	1) progress bar is wrong
	2) stop makes an error
fixed (1)
fixed (2)
but now, progress bar has 2 problems
- it does not go back to 0 when Stop
- second run without switching out of Evolution flickers (like it's trying to do 0,n,0,n,..)

looks OK now
but strange bug
every once in a while, parseAcid gives an error that it can't find the amino acid "MSNRHILCSYTKVSVLAAVVKKKK"
(some long aa seq)
it looks like, instead of being fed a single char, it is getting the whole string
why??
it does not always happen...
put in a tracer in ProteinUtilities (the responsible calling routine)

somehow, the archive entry, instead of having aa;dir;aa;dir, is just having a protein sequence...
it's not in the saved archive
try saving the archive when it happens

strange, it blew up on
MSNRHILFAIQG
the entry in archive.txt is:
MSNRHILFAIQG;MSNRHILFAIQG;255/255/255
- no directions were inserted into the protein string 
(a normal entry looks like: MMSS;M: E:M: E:S: E:S:none:;255/255/255)
why!?!?
set up a flag on entry into archive if no ":" present
- it reports many!
     [java] bad one:MSSAISPIDRHILCAIIS MSSAISPIDRHILCAIIS java.awt.Color[r=255,g=255,b=255]
     [java] bad one:MSNRHILLV MSNRHILLV java.awt.Color[r=255,g=255,b=255]
     [java] bad one:MSS MSS java.awt.Color[r=255,g=255,b=255]
     [java] bad one:MSSR MSSR java.awt.Color[r=255,g=255,b=255]
     [java] the aa seq was-MSS-
     [java] biochem.FoldingException: acid not found. ACID: MSS TABLE: standard
- it only happened to gag on one..

it looks like, in Multi.. I was submitting the sequence to the DB twice
  since FoldingManager.fold automatically does it

5/30/08
but it runs soooo slowly
probably thread issues.
benchmark on office mac dual 2.5ghz G5 with 2gb ram
(with stuff running in background: word, firefox playing internet radio)
10x10
mut freqs all 0.005
start with green 1
all fitness = 5
10 generations = 7:16, 10:08

try setting numProcessors = 1;
10 generations = 12:00, 13:25

somewhat slower
but I'm using the threads wrong
1) make the receiver of folded sequences be a LinkedBlockingQueue
	- actually, can't do that since archive is a HashMap
	- so use Collections.synchronizedMap(archive) for access 
2) no need for thread pool 
3) use join() to wait for completion of the threads

now 7:49, 4:44

made version 1.0

runs very unreliably
null pointer exceptions
PUNT the thread stuff
- archived the semi-working code to a cd (in binder at home)

go back to old version
- fold as you go and folding server

5/31/08
go back to old version as above
(actually keep some changes & roll back others)
- make FoldingManager a singleton
- change stop to "pause" and start to "run"

seems OK
set default mutation rates lower

weird bug - only when saving pix of generations, the progress bar
   stops updating (and cursor goes back to normal) after the first generation
  probably because ALL the things that are called in Evolver
  need to be in Evolver (for thread stuff)
 - still NG (unclear why...)

added ability to show the colors of the two alleles in the upper left
  corner of each cell in the world
  
6/1/08
it runs a long time but always ends in random errors
probably bad thread safety.

try adding synchronization
first, benchmark the new version
on laptop thru Eclipse
10x10 - don't show stuff in corner
green 1
all = fitness
run until you see "generation 10"
all mut freq's 0.001
- 1:43, 1:38, 1:58

synchronize all methods in FoldedProteinArchive
benchmark again:
- 1:58, 1:30, 1:51
	no significant difference! good

now try a really long run to look for crashes

still does

the singletons are also trouble.
fix them to be multiples
	and be sure they're not shared with other objects
1) folding manager
	need to fix
		- biochemworkpanel
		- moboworkpanel
		- mutator
		- proteinUtilities
	need to move this out of ThinOrganism
		make ThinOrganismFactory that builds ThinOrganisms from incomplete ones
2) geneExpresser (also needed for ThinOrganism)

still fails
168 generations
     [java] Exception in thread "Thread-5" java.lang.NullPointerException
     [java] 	at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
     [java] 	at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
     [java] 	at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
     [java] 	at biochem.Folder.fold(Folder.java:59)
     [java] 	at biochem.FoldingManager.foldPP(FoldingManager.java:393)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:303)
     [java] 	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
     [java] 	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
     [java] 	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:51)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:223)
     [java] 	at evolution.Evolver.run(Evolver.java:64)
     [java] 	at java.lang.Thread.run(Thread.java:613)

- thread 5!?!
try again to see if same error
ran to 1300+ generations OK! (but was runing very fast at end because most had no mRNA)

try again

generation 109
     [java] Exception in thread "Thread-3" java.lang.NullPointerException
     [java] 	at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
     [java] 	at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
     [java] 	at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
     [java] 	at biochem.Folder.fold(Folder.java:59)
     [java] 	at biochem.FoldingManager.foldPP(FoldingManager.java:393)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:303)
     [java] 	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
     [java] 	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
     [java] 	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:52)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:223)
     [java] 	at evolution.Evolver.run(Evolver.java:64)
     [java] 	at java.lang.Thread.run(Thread.java:613)


same place - different generation

try synchronizing the World

ran 2460 generations overnight!
(but had not chnaged fitnesses as it ran...)
try again

6/2/08
ran on pc
died 2x after about 180 generations

C:\Documents and Settings\Brian\Desktop>java -jar MGX.jar
Exception in thread "Thread-5" java.lang.NullPointerException
        at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
        at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
        at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
        at biochem.Folder.fold(Folder.java:59)
        at biochem.FoldingManager.foldPP(FoldingManager.java:393)
        at biochem.FoldingManager.fold(FoldingManager.java:303)
        at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
        at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
        at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:52)
        at evolution.Evolver.makeNextGeneration(Evolver.java:223)
        at evolution.Evolver.run(Evolver.java:64)
        at java.lang.Thread.run(Unknown Source)

C:\Documents and Settings\Brian\Desktop>java -jar MGX.jar
Exception in thread "Thread-3" java.lang.NullPointerException
        at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
        at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
        at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
        at biochem.Folder.fold(Folder.java:59)
        at biochem.FoldingManager.foldPP(FoldingManager.java:393)
        at biochem.FoldingManager.fold(FoldingManager.java:303)
        at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
        at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
        at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:52)
        at evolution.Evolver.makeNextGeneration(Evolver.java:223)
        at evolution.Evolver.run(Evolver.java:64)
        at java.lang.Thread.run(Unknown Source)

same failures as before on mac...

the only thing left to deal with is the counts of each color
- keep the counts in a synchronized class
- updateCounts is currently in EvolutionWorkArea (out of the evolver thread, which calls it)
- try putting updateCounts in Evolver
	with a call-back to mge to let it know that there's a new generation


6/3/08
- but it runs AOK on the 2-processor mac
only dies on 1-processor pc
- so probably a thread thing

tried extensive refactoring to put just the folding in a thread
but GUI wouldn't update while waiting for join.

so go back to this version and try to get gui OK
(it still has the problem that the progress bar disappears...)

move Evolver and EvolverTimer from mgx to EvolWArea

it MAY be OK...

new bug
- in genex, a sequence w/o promoter or term shows a term highlighted
- OK fixed

run a long time on mac and pc

it still crashes on mac (office mac with 2 g5 processors and other stuff running..)
     [java] Exception in thread "Thread-3" java.lang.NullPointerException
     [java] 	at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
     [java] 	at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
     [java] 	at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
     [java] 	at biochem.Folder.fold(Folder.java:59)
     [java] 	at biochem.FoldingManager.foldPP(FoldingManager.java:393)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:303)
     [java] 	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
     [java] 	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
     [java] 	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:51)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:222)
     [java] 	at evolution.Evolver.run(Evolver.java:67)
     [java] 	at java.lang.Thread.run(Thread.java:613)

try synchronizing the createThinOrganism methods

still NG

6/4/08
try synchronizing FoldingManager.fold()
first benchmark 10 generations on office PC (2.4ghz single processor 1gb ram win xp)
1:32, 1:45, 1:47

make change & rerun
1:19, 0:57, 1:22
- actually FASTER!
then run a looong time

still dies at 170 generations on office mac (dual g5)
on PC (single processor), it goes much longer (334) but still dies

made it look for Desktop directory in save pix and save world

try synchronizing Evolver.makeNextgeneration()

still NG
PC dies after 227 generations
Exception in thread "Thread-3" java.lang.NullPointerException
        at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
        at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
        at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
        at biochem.Folder.fold(Folder.java:59)
        at biochem.FoldingManager.foldPP(FoldingManager.java:393)
        at biochem.FoldingManager.fold(FoldingManager.java:303)
        at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
        at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
        at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:51)
        at evolution.Evolver.makeNextGeneration(Evolver.java:222)
        at evolution.Evolver.run(Evolver.java:67)
        at java.lang.Thread.run(Unknown Source)

Mac dies after 485 generations
Exception in thread "Thread-3" java.lang.NullPointerException
	at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
	at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:74)
	at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
	at biochem.Folder.fold(Folder.java:59)
	at biochem.FoldingManager.foldPP(FoldingManager.java:393)
	at biochem.FoldingManager.fold(FoldingManager.java:303)
	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:51)
	at evolution.Evolver.makeNextGeneration(Evolver.java:222)
	at evolution.Evolver.run(Evolver.java:67)
	at java.lang.Thread.run(Thread.java:613)

they both die at the SAME place 
maybe it's not a thread thing
maybe it's a 'poison sequence' that somehow gets parsed to cause trouble
put in a tracer to see what's up.

BruteForceFolder 125 is 		for (int i = 0; i < next.length; i++) {
the null is probably next (a Direction[])

IncrementalFolder 74 is 			
	recurse(grid.getNextDirection(acids[current - 2].next), current,
					localLookAhead);
so, put in a trap for when grid.getNextDirection(acids[current - 2].next) == null
	have it print grid.aaseq

if (grid.getNextDirection(acids[current - 2].next) == null) {
	System.out.println("the sequence was:" + grid.getPP().getSingleLetterAASequence() + "!"
			+ "\n" + grid.getPP().getLength() 
			+ "\n" + grid.getPP().toCSV());
}
run this on PC while doing other things...

found it on mac
     [java] the sequence was:MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK!
     [java] 31
     [java] Exception in thread "Thread-3" java.lang.NullPointerException
     [java] 	at biochem.BruteForceFolder.recurse(BruteForceFolder.java:125)
     [java] 	at biochem.IncrementalFolder.placeRestOfAcids(IncrementalFolder.java:79)
     [java] 	at biochem.BruteForceFolder.realFold(BruteForceFolder.java:107)
     [java] 	at biochem.Folder.fold(Folder.java:59)
     [java] 	at biochem.FoldingManager.foldPP(FoldingManager.java:393)
     [java] 1.41, -4.34, -4.34, 0.87, 3.98, -4.34, 0.01, -6.49, 3.98, -15.86, -5.6, -5.6, 2.04, 1.39, -15.86, -4.34, -6.49, -3.51, 0.0, -1.08, 3.1, -1.08, 3.1, 0.87, 0.87, 3.1, 0.0, -6.49, -6.49, -6.49, -6.49, 
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:303)
     [java] 	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:100)
     [java] 	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:91)
     [java] 	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:51)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:222)
     [java] 	at evolution.Evolver.run(Evolver.java:67)
     [java] 	at java.lang.Thread.run(Thread.java:613)
     
tested in Aipotu's biochem workbench
MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK is a poison sequence!

also toxic in protex

see what part is toxic
- halves
MSSAISPKIRHHFWRS - ok
KTGYVYVAAVGKKKK - ok

cut from carboxyl term
MSSAISPKIRHHFWRSKTGYVY - ok
MSSAISPKIRHHFWRSKTGYVYV - ok
MSSAISPKIRHHFWRSKTGYVYVA - toxic (minimum from carboxyl end)
MSSAISPKIRHHFWRSKTGYVYVAA - toxic
MSSAISPKIRHHFWRSKTGYVYVAAVG - toxic

cut from N-term
 SSAISPKIRHHFWRSKTGYVYVAAVG - OK
 
so the minimum toxic one is
MSSAISPKIRHHFWRSKTGYVYVA

but it dies at a different place when run from biochem
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:108)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)
     [java] 	at biochem.TwoDGrid.getProteinColor(TwoDGrid.java:159)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:304)

see if you can get the direction string
MSSAISPKIRHHFWRSKTGYVYVA - actually fails at a different place
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:108)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)
     [java] 	at biochem.TwoDGrid.getProteinColor(TwoDGrid.java:159)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:304)
     [java] 	at biochem.BiochemistryWorkpanel$1.actionPerformed(BiochemistryWorkpanel.java:105)

HexGrid 108 is
	public GridPoint nextCell(Direction direction, GridPoint p) {
		int x = p.x;
		int y = p.y;
	another time that it's looking for a non-existent next cell
	
MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK gives this result:
     [java] the sequence was:MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK!
     [java] 31
     [java] 1.41, -4.34, -4.34, 0.87, 3.98, -4.34, 0.01, -6.49, 
       3.98, -15.86, -5.6, -5.6, 2.04, 1.39, -15.86, -4.34, -6.49, 
       -3.51, 0.0, -1.08, 3.1, -1.08, 3.1, 0.87, 0.87, 3.1, 0.0, 
       -6.49, -6.49, -6.49, -6.49, 
     [java]  E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : 
       SE : SE :  E : SW : SW : NW : NW :  W : SW :  E : none : 
       none : none : none : none : none : none : none : none : none : 
try laying it out on a hexagonal grid
- it has "painted itself into a corner" - in the center of a core
  so there are no empty directions => it cannot place the next aa
- need to give up on this branch and try another

e-mailed Ethan; he said:
Interesting! Large random test sets often uncover bugs. I remember
_thinking_ about painting into a corner but don't remember doing
anything about it.

Yes, the solution is to abort that potential shape. The easiest way to
do that is probably the cleanest: don't look for painted into a
corner. Just test for null next direction. If the test returns true,
set the energy to infinity (e.g. Double.MAX_VALUE) and stop
recursing. That might require a break from the while loop. The
infinite energy will mean that this shape won't be considered the best
so far.

- so I need to get recurse() to return not recurse further (call tryDirection())
fix in BruteForceFolder

	public void recurse(Direction[] next, int current, int stop) {
		if (next == null) {
			System.out.println(grid.getPP().getSingleLetterAASequence() 
					+ " painted into a corner!");
			energy = infiniteEnergy;
			return;
		}
		for (int i = 0; i < next.length; i++) {
			tryDirection(next[i], current, stop);
		}
	}

now it dies in the same place the shorter one does
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:108)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)
     [java] 	at biochem.TwoDGrid.getProteinColor(TwoDGrid.java:159)
when it tries to get the color 
- somehow, this is becoming the accepted fold!

probably, the last amino acid does not have a direction?
let's see

the toxic one MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK
gives
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java]  E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : 
            SE :  E : SW : SW : NW : NW :  W : SW :  E : none : none : 
            none : none : none : none : none : none : none : none : 
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:111)
 
 it never got fully folded 
 maybe infiniteEnergy is the wrong way...
 - no, that's right - probably bailed at wrong place
 try in IncrementalFolder placeRestOfAcids
 
	protected void placeRestOfAcids() {
		current = 2; // ready to place 3rd acid
		while (current < numAcids) {
			resetEnergy();
			int localLookAhead = Math.min(current + lookAhead, numAcids);
			if (grid.getNextDirection(acids[current - 2].next) == null) {
				System.out.println(grid.getPP().getSingleLetterAASequence() 
						+ " painted into a corner");
				energy = infiniteEnergy;
				break;
			}
			recurse(grid.getNextDirection(acids[current - 2].next), current,
					localLookAhead);
			restore();
			// unplace some acids
			for (int i = current + step; i < localLookAhead; i++) {
				grid.unset(acids[i]);
			}
			current += step;
		}
	}
 
ng

     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner
     [java]  E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : SW : SW : NW : NW :  W : SW :  E : none : none : none : none : none : none : none : none : none : none : 
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:111)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)

still not right.

- maybe the energy is getting re-computed and over-writing my value

more poison sequences:
MAGVRAVRVLRYAACCVCMFCAPMHLRITLKKKK
MSKCFKPQRTAARFCVSTNVSVLETLVDSKKKK

6/6/08
- the energy gets recalculated in saveIfNecessary(), so setting it along the way 
  won't work
- need to set a boolean in grid paintedIntoACorner
  and check that in grid.getEnergy
  if it's set, make energy max.

in BruteForceFolder.recurse()

now dies in coloring algorithm
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] 	 E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : 
             SW : SW : NW : NW :  W : SW :  E : none : none : none : none : none :    
             none : none : none : none : none : 
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] 	 E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : 
             SW : SW : NW : NW :  W : SW :  E : none : none : none : none : none : 
             none : none : none : none : none : 
     [java] tried to calculate energy of painted into corner
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:108)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)

why?
see what fold is there in HexGrid 108
- it is the partly-folded one
why is it stopping with that one?

try in BruteForceFolder.tryDirection()
NG - it hits the nullPointer before being trapped (unclear why)

put back in recurse
- trouble because it never fully folds the protein
	so the saveIfNecessary is not reached
- somehow, need to make it think all placed, so it checks the energy and abandons it

try in IncrementalFolder.placeRestOfAcids()
	protected void placeRestOfAcids() {
		current = 2; // ready to place 3rd acid
		while (current < numAcids) {
			resetEnergy();
			int localLookAhead = Math.min(current + lookAhead, numAcids);
			//if the next is null, it means there's no open places
			//  for the next aa, so we're 'painted into a corner'
			//  so need to abort this branch here (or it'll get a
			//  NullPointerException) AND notify the grid.getEnergy
			//  method that this is a BAD fold.
			if (grid.getNextDirection(acids[current - 2].next) == null) {
				System.out.println(grid.getPP().getSingleLetterAASequence() 
						+ " painted into a corner!"
						+ "\n\t" + grid.getPP().getDirectionSequence());
				grid.setPaintedIntoACorner(true);
			} else {
				recurse(grid.getNextDirection(acids[current - 2].next), current,
						localLookAhead);
			}
			restore();
			// unplace some acids
			for (int i = current + step; i < localLookAhead; i++) {
				grid.unset(acids[i]);
			}
			current += step;
		}
	}

ng
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] 	 E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : SW : SW : NW : NW :  
              W : SW :  E : none : none : none : none : none : none : none : none : none : none : 
     [java] MSSAISPKIRHHFWRSKTGYVYVAAVGKKKK painted into a corner!
     [java] 	 E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : SW : SW : NW : NW :  
               W : SW :  E : none : none : none : none : none : none : none : none : none : none : 
     [java] Exception in thread "AWT-EventQueue-0" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:112)
     [java] tried to calculate energy of painted into corner
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)
     [java] died at hex grid 108
     [java] 	at biochem.TwoDGrid.getProteinColor(TwoDGrid.java:164)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:304)
     [java] 	 E : NE :  W :  W :  W : NE : NW :  E : NE : NE :  E : SE : SE :  E : SW : SW : NW : NW :  
             W : SW :  E : none : none : none : none : none : none : none : none : none : none : 
     [java] 	at biochem.BiochemistryWorkpanel$1.actionPerformed(BiochemistryWorkpanel.java:105)

it is never getting to getEnergy from saveIfNecessary()
the getEnergy() call generating the "tried to calculate energy of painted into corner"
  is probably when it's all done and decided that this is the best fold


the problem is, because it's incremental, it keeps digging itself into the same hole
need a way to start over but not follow the same path

6/7/08
punt - if it paints itself into a corner, just fire an exception
and pick a new sequence from the gene pool
- make a subclass of FoldingException PaintedInACornerFoldingException
- delete the paintedInACorner boolean from Grid
- build into BruteForceFolder recurse()
	 a trap for null reference that fires PaintedInACornerFoldingException
	 
ran overnight 742 generations:
     [java] Had to replace sequence: MSIAIIPKHRHGFVRSLAQGMLLAGSSKKKK
     [java] 	Generation 137
     [java] 	TotalFolded=2600
     [java] 	Total replaced=1
     [java] Had to replace sequence: MSIAMNPQRIGRVCALLAQGMLLAGSSKKKK
     [java] 	Generation 141
     [java] 	TotalFolded=2701
     [java] 	Total replaced=2
     [java] Had to replace sequence: MSIGIIPNIRQRFGPTEARYGNSEQVVKKKK
     [java] 	Generation 198
     [java] 	TotalFolded=4150
     [java] 	Total replaced=3
     [java] Had to replace sequence: MSYCLVRPKTRQRLFVAMPEMLLVMRQQVKKKK
     [java] 	Generation 357
     [java] 	TotalFolded=8636
     [java] 	Total replaced=4
     [java] Had to replace sequence: MSYCLLPKTRHRLFVAWPEMVMVSDTQVKKKK
     [java] 	Generation 381
     [java] 	TotalFolded=9394
     [java] 	Total replaced=5
     [java] Had to replace sequence: MFNAAAYAPESERLWVSWTYSLLPVWEVVARQKKK
     [java] 	Generation 616
     [java] 	TotalFolded=16887
     [java] 	Total replaced=6

replaced 6 out of 16887 = 1/2800 or 0.03%
pretty low; so leave it as is

maybe take out some of the synchronized things?

overight run on laptop
generation 1250
it DIED!

     [java] Had to replace sequence: MSSAISPNIRHHFVRYTMVSVLAAVVKKKK
     [java] 	Generation 64
     [java] 	TotalFolded=1170
     [java] 	Total replaced=1
     [java] Had to replace sequence: MMSSAIAAKNAHFVALYMVLYGGSSKKKK
     [java] 	Generation 143
     [java] 	TotalFolded=3051
     [java] 	Total replaced=2
     [java] Had to replace sequence: MSSAENGKHGWFCWALIHMVMVLPLYTKKKK
     [java] 	Generation 268
     [java] 	TotalFolded=6164
     [java] 	Total replaced=3
     [java] Had to replace sequence: MKKQPLAAMLYLHLYPACTRFIYSTARKKKK
     [java] 	Generation 1211
     [java] 	TotalFolded=26048
     [java] 	Total replaced=4
     [java] died at hex grid 108
     [java] 	 E :  E : NE : NW :  W : NW : NE :  W : SW :  W : SE : SW : SW : SW :  E :  E : NW : NE : NE : SE :  E : none : none : 
     [java] Exception in thread "Thread-3" java.lang.NullPointerException
     [java] 	at biochem.HexGrid.nextCell(HexGrid.java:112)
     [java] 	at molGenExp.RYBColorModel.getProteinColor(RYBColorModel.java:92)
     [java] 	at biochem.TwoDGrid.getProteinColor(TwoDGrid.java:160)
     [java] 	at biochem.FoldingManager.fold(FoldingManager.java:304)
     [java] 	at evolution.ThinOrganismFactory.foldOntoHexGrid(ThinOrganismFactory.java:102)
     [java] 	at evolution.ThinOrganismFactory.foldAndComputeColor(ThinOrganismFactory.java:94)
     [java] 	at evolution.ThinOrganismFactory.createThinOrganism(ThinOrganismFactory.java:55)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:232)
     [java] 	at evolution.Evolver.run(Evolver.java:68)
     [java] 	at java.lang.Thread.run(Thread.java:613)

- it tried to color a folded-in-the-corner one
- interesting that it did not fail in the folding 
 	maybe because it's the second-to-last aa? (why is that important?)
=> need to put a trap in HexGrid also

- this one percolates up to a LOT of places (anywhere that asks for color)

- when this fails in any "fold" button - need to pop up a dialog warning that protein 
	couldn't be folded
	
seems OK
do a long run

ran on pc for 24 hrs
Had to replace sequence: MSGAISPLQVTRTFIWPMHKGFELVASMLKKKK
        Generation 281
        TotalFolded=6159
        Total replaced=1
Had to replace sequence: MPEAKSPVQLRAGVHFFALARKLLATGSPSKKKK
        Generation 499
        TotalFolded=12483
        Total replaced=2
Had to replace sequence: MQAGKLLSNVCTLFILALLHIVCKYIVR
        Generation 532
        TotalFolded=13451
        Total replaced=3
Had to replace sequence: MPEAKIPVQLRAGAFFCPCTDCWLTVPYKKKK
        Generation 546
        TotalFolded=13856
        Total replaced=4
Had to replace sequence: MLTYDAESLTSFFTSCFLGGYQEPAGCASYLLSIKKKK
        Generation 897
        TotalFolded=24621
        Total replaced=5
Had to replace sequence: MLRVPRYTLQFFFTGFPGASEWDVFGT
        Generation 1135
        TotalFolded=31738
        Total replaced=6
Had to replace sequence: MWLRVPTLVNIFLFFAWLPGKCRWGFVKLKKKK
        Generation 1186
        TotalFolded=33176
        Total replaced=7
Had to replace sequence: MMDTNIASVVSVPFSEGLQGTAGGVYTIIKKKK
        Generation 1193
        TotalFolded=33389
        Total replaced=8

for this run 8/35857 = 0.02% or 1/4400 bad sequences
also ~1500 sequences folded per hour or 25/min

overall "bad sequence" rate: 18/78792 = 0.022% or 1/4300 bad sequennces

7/18/08
making snapshots better - not just screenshots of panels 
  (these cut off the parts that aren't visible...)
  
made version 1.1

10/8/08
for color-blind people (and because the colors are hrd to see)
make tool-tip popups with the color name in text.

- first, fix utilities.ColorModel and molGenExp.RYBColorModel
	to have method to get name of color
	
- add to molGenExp.OrganismCellRenderer

NEED TO 
	- make a preference setting (default to on)
	- add to color chip in biochem & mobo
	- add a color counter for genetics hist list items

10/9/08
	- made prefs setting
	- did color chips in
		biochem.BiochemistryWorkpanel
		mgx.CombinedColorPanel
		molBiol.MolBiolWorkpanel
	- color counter in genetics.Tray
		and in genetics.GenHistListCellRend

10/28/08
	- added color name to screenshot functions in biochem & mobo
	
called it version 1.2

12/24/08
bug - if there are no organisms in the gene pool (fitness = 0 for only color)
    then it warns you, but after clearing dialog, you can only run
    not load or change fitnesses!
    - fixed
    
new feature - mutation off checkbox in mutation prefs panel
	- turns off mutation
	- keeps mutation rates set but grayed out

called it version 1.2.1

1/3/09
- added a "run one generation" button to Evolution
- save greenhouse files automatically
	- if add one or delete one, save all

1/4/09
bug - color counts not updated on load
keep same version # (hadn't posted it to the web yet)
	
1/6/09
bug - in evolution, selected critter in World never de-selected
	on add, run, pause, etc.

1/11/09
called it version 1.2.2 and posted mac & pc versions

10/27/09
bug fix
- save greenhouse as does not work

added features
- backbone trace in purple (GridCanvas)
- hitting return in biochem and mobo folds the protein

10/29/09
made version 1.2.3 & posted mac and pc versions

07/01/10
lots of updates
1) don't replace sequences when folded in a corner.
	- have folder return null for the shape
	- any organism that gets one of these is DEAD
		- it's fitness = 0
		- it's color is gray
	- don't replace sequences
		- don't count replaced sequences
		- do count dead ones
	- did it this way:
		0) remove all folding server code
		1) remove 'fold locally' methods from Evolver
			do it all as though on a server (but no server anymore)
		2) have folder still throw exception
			but in Evolver, if you catch it, make color & shape = null
		3) if either of an organism's colors = null; it's dead. color number = -1
			fixed stuff in RYBColorModel
	- currently, it only saves FoldedInACorner proteins in the archive in evolution	mode
		in biochem, mobo, and genetics, they're rare
		and it's a pain to fix the code...
do a long run to see what happens with dead ones..

didn't see any
need a better test
make a poison DNA (using reverse translation site: www.bioinformatics.org/sms2/rev_trans.html
from poison protein MLRVPRYTLQFFFTGFPGASEWDVFGT
GGTATAACCATGCTGCGCGTGCCGCGCTATACCCTGCAGTTTTTTTTTACCGGCTTTCCGGGCGCGAGCGAATGGGATGTGTTTGGCACCTAACCGGGGG

need to change one aa so not poison
GGTATAACCATGCTGCGCGTGCCGCGCTATACCCTGCAGTTTTCTTTTACCGGCTTTCCGGGCGCGAGCGAATGGGATGTGTTTGGCACCTAACCGGGGG
is actually red..

on second generation, one died and was logged, but nullPointerException in MolBiolWorkpanel
	when it tries to find an image of the protein
	
7/2/10
need to clean up all the protein folding stuff
- it's now different in several different places
- it should be encapsulated so all requests go thru one of two methods
	- should take any aaSeq format
		foldAndColor(String aaSeq) - returns proteinFoldString and Color (FoldedAndColoredProtein)
		foldWithPix(String aaSeq) - returns Color, big and thumbnail images 
				(FoldedProteinWithImages; formerly "FoldedPolypeptide")
			if FoldedInACorner, proteinFoldingString & Color = null
			it also is the only one with access to the FoldedProteinArchive
				it deals with all inputs and outputs
	- use ProteinImageFactory to make pix
	- this means making the folded images in biochem just pictures
build this in Biochem.FoldingManager
	- move all stuff in Utilities back to the local places
make FoldingManager.fold(String) private <temporarily> so you can find all the places to fix
	- move FoldedProteinArchive & FoldedProteinArchiveEntry to Biochem
	- 
7/6/10
need to do a little cleanup
- in biochem, a color of null is mapped to white - this is a leftover from early coloring
	where no color was white
		need to fix since Color=null means a folded in a corner protein
	- in MolGenExp.RYBCOlorModel.java, it never returns NULL for a color
		(this only happens in FoldingManager)
			so can safely remove it from BiochemistryWOrkPanel's getColor method
	
now need to fix evolution of dead ones
still hangs
- took some synchronized's out of ColorCountsRecorder (probably not needed)
- in ColorCountsRecorder, fixed counting of dead color
now OK

other fixes:
- shouldn't be able to save dead organism to Greenhouse (MolGenExp line 866) 
	all set

7/9/10
misc fixes
- the purple is not a good color 
	set all colors in one place (RYBColorModel)
		nix ColorUtilities
		put it's getColorFromName(String name) into RYBColorModel

- added average fitness for each generation

- changed middle exon color in mobo (GeneExpresser line 299)

11/11/10
the Rr self cross seems to be giving odd ratios (too few whites)
so run 10 self-crosses of red:
174 red : 64 white (2.7:1)
3:1 expects 178.5:59.5
chi-squared p-value = 0.5
* so not a significant deviation
* so OK!

3/15/11
evolution died after 24 generations
(no grays yet)
     [java] Exception in thread "Thread-4" java.lang.NullPointerException
     [java] 	at molGenExp.RYBColorModel.mixTwoColors(RYBColorModel.java:181)
     [java] 	at evolution.Evolver.makeNextGeneration(Evolver.java:221)

     in mixTwoColors
     		int aNum = ((Integer)colorToNumberMap.get(a)).intValue();
found it
     [java] rybcolormodel: colA=java.awt.Color[r=255,g=100,b=0] colB=java.awt.Color[r=0,g=255,b=0]
     [java] Exception in thread "Thread-3" java.lang.NullPointerException
orange should only be 255,140,0 not 255,100,0 
somewhere, there's another orange...

found it in the folded protein archive
MSNRHILLVFWRQ has color 255/100/0 - the old orange
so delete folded prot archive and re-make

now should be ok
version 1.3.0
run a lot to be sure ok

overnight
1343 generations, 33,817 proteins, 8 lethal OK
860 gen, 17,536 prot, 1 lethal OK

3/16/11
added relative fitness calc and display
version 1.3.1

527 generations; 14,417 prots; 1 lethal OK
574; 17,630; 7 OK

3/17/11
made mac, pc, linux versions & posted

6/16/11
troubles in Biochem
- folding from entered seq never showed sequence or protein (but it was folded)!
- layout issues
fixed them all

6/17/11
fixed MoBo to have better listener for text selection
(done in genex first)
in mol biol workpanel - replace caretListener with mouseListener
fixed other misc bugs

version 1.3.2
made mac, pc, and linux versions

8/24/12
OS X Mountain Lion's security now warns users that Aipotu is corrupted and needs
	to be thrown in the trash!
- really, it needs to be signed
- became Apple developer and got signature files

Here's how to sign it (on the laptop):
export CODESIGN_ALLOCATE="/Applications/Xcode.app/Contents/Developer/usr/bin/codesign_allocate"
codesign -s "Developer ID Application: Brian White" -vf Aipotu-1.3.2.app/
Aipotu-1.3.2.app/: replacing existing signature
Aipotu-1.3.2.app/: signed bundle with Mach-O universal (i386 ppc7400 x86_64) [edu.umb.bio.Aipotu]

now AOK

put signed versions in office mac ReadyToRun as well as on web etc.

4/14/17
see VGLII notes for this
- need to deal with new Mac OS security stuff
PC is AOK
only for mac
need to make a single .app bundle with Greenhouse/ inside it
  and be sure that Aipotu can find that folder
  use the parameter tricks used by VGLII

 arrange to pass in params into MGE's constructor and test when opening greenhouse
 
 some trouble getting the bundleapp task going - 
 	copied in text from VGLII's build.xml
 	but "taskdef class com.oracle.appbundler.AppBundlerTask cannot be found
 look in VGLII development log
 - made folder lib/
 - copy and paste (using eclipse) appbundler-1.0.jar from VGLII/lib to MolGenExp/lib
 - add lib/ to the java build path (properties) as a "Class folder"
 now builds app aok
 
 works
 see if you can copy in Greenhouse/ when you make the .app using Ant
 		<copy todir="Aipotu-1.3.3.app/Contents/Java/Greenhouse">
			<fileset dir="Greenhouse"/>
		</copy>
 works AOK
version 1.3.3 - only for mac

add icon and put in Javastuff/ReadyToRun/MolGenExp-Aipotu/Aipotu/Version 1.3.3/
	can't seem to get icon to work - won't change the image..
	maybe it has cached it??
it took a little fussing but it may have worked

try to sign it
[briansofficemac:MolGenExp-Aipotu/Aipotu/version 1.3.3] brian% codesign -f -v -s "Developer ID Application: Brian White (RNA5B8HQ54)" Aipotu-1.3.3.app/
Aipotu-1.3.3.app/: unsealed contents present in the bundle root

fails - this sort of thing was fine in VGLII..

it looks like Greenhouse should be in the top level of the .app
try that.
still NG

look at where apple says to put resources
https://developer.apple.com/library/content/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html#//apple_ref/doc/uid/10000123i-CH101-SW1

misread the iOS not macOS stuff - need to put them in Contents/Resources
	try that
	it worked when I manually put the Greenhouse in the Contents/Resources not when ant does it??

it could be that I'm building it in a folder that SugarSync is using
build it on desktop first
	- in eclipse, buiild app (it builds Greenhouse into Contents/Resources/)
	- copy app to desktop
	- paste in icon file "big mac icon.ico" to get info window
	- codesign
[briansofficemac:~/Desktop] brian% codesign -f -v -s "Developer ID Application: Brian White (RNA5B8HQ54)" Aipotu-1.3.3.app/
Aipotu-1.3.3.app/: signed app bundle with Mach-O thin (x86_64) [edu.umb.aipotu]
[briansofficemac:~/Desktop] brian% ./check-signature Aipotu-1.3.3.app/
(c) 2014 Apple Inc.  All rights reserved.
YES

- zip from mouse (not command)
- now, put them in the ReadyToRun folder
- try putting on web

it runs OK and can find Greenhouse but when you save strains to the Greenhouse, they appear in Greenhouse list
  but are not saved in Aipotu-1.3.3.app/Contents/Resources/Greenhouse

4/18/17
two alternatives:
- in both cases, on startup, if Greenhouse isn't in the appropriate spot, create it and fill it from the
	Greenhouse/ folder in the .app
1) Put it in ~/Library/Application Support/Aipotu
	- advantages = automatic, canonical, out of the way
	- disadvantages = people won't know where it is
2) Use preferences to have the user choose - on startup "Save" is grayed out but "save as..." is available
	they choose the folder and it gets populated - then pref is saved
	- advantages = easy, user-friendly
	- disadvantages = the user might put it somewhere strange..

probably the best is (2)

5/1/17
made GlobalDefaults.onMac boolean to flag if on mac or not
	if not, then the save greenhouse etc is as is it has been
	if on mac, 
		if no directory in preferences
			save greenhouse is grayed out until they specify a directory

NEED TO SAVE THE FOLDED PROTEIN ARCHIVE when you save the greenhouse

BE CAREFUL - some places do the saving/loading to File(GlobalDefaults.GlobalDefaults.greenhouseDirName)
	but they should always use the greenhouseDirectory - make that a global??
	- pass in the greenhouseDirectory as a parameter
		this is too nasty - need to make it a "preference"

Need to be careful about what happens on windows. Do not need "onMac" - remove
	it should be OK - if they do a "save as", it will remember their choice
	
oh crap - all the save to greenhouse etc check to see if the directory exists and if so, save there
	need to make them pick a directory on mac somehow...

5/3/17
best to build it into MGEPrefs - the first time you look for the directory, you deal with setting it etc
	have a String in prefs - osXappRootDir - starts NULL, if non-NULL we're on mac and must act accordingly

5/4/17
don't figure out the directory thing when you construct the prefs - it's too early (you haven't even got the args[])
	do it when you first are asked for the greenhouseDirectory
	BUT this is a problem - the first access on mac will probably be to load the GH - you can use the GH in the app
		you only need to have a new directory when you need to save to the GH
		how to deal with this?? It shouldn't bug them unless you have to.
in setupUI() - the first load of the GH should 
	on mac - get it from in .app
	on PC - get if from same dir as .exe 
	and set the directory in MGEPrefs to what you just used
	and grey out save greenhouse on mac
then, in any further GH write/read, use the one in MGEPrefs
	BUT if on mac and prefs has the .app's dir, you need to ask them to find another
maybe can do this by looking at why the OS refuses to write to the app's dir - what's the error?

5/5/17
see if you can find the error that happens when you try to write to the GH
			File test = new File(args[0].replace("-D", "") + "/Contents/Resources/" + GlobalDefaults.greenhouseDirName);
			JOptionPane.showMessageDialog(null, test.getAbsolutePath() + " " + test.canWrite());
this gives .app/Contents/Resources/Greenhouse TRUE - so you should be able to write...

			File test = new File(args[0].replace("-D", "") + "/Contents/Resources/" + GlobalDefaults.greenhouseDirName);
			try {
				AccessController.checkPermission(new FilePermission(test.getAbsolutePath(),"read,write"));
			} catch (AccessControlException e1) {
				JOptionPane.showMessageDialog(null, test.getAbsolutePath() + " NOT OK");
			}
			JOptionPane.showMessageDialog(null, test.getAbsolutePath() + " ok");

gives the "NOT OK" dialog - so this may be the way to do the test when we do the loading/saving.

so - make a "GreenhouseFileManager" singelton class that handles all load/save requests and manages the directory
	if it ever has trouble writing, it asks for a new dir.
	be careful - FoldedProteinArchive loads & saves there
	the GFM has saveGreenhouse() and saveFileToGreenhouse() as well as loadGreenhouse() and loadFileFromGreenhouse()

5/8/17
on construction - use the default directories (windows: same dir as usual; mac - the app root /Contents/ etc)
on any future save/load file
	test if can read/write
	if can't - ask them for a directory where Greenhouse/ will go (default to Desktop)
		maybe check permissions on this also (make a loop)
actually, better to just do this always - at main() call setGHdir() depending on mac/pc
	then, when called - check specifically read/write as needed as well as existence
	be sure it's OK if there's no greenhouse - opens with empty one (as opposed to crashing)
	
5/9/17
need to test carefully the AccessController thingy - the directory probably didn't exist then
	see what happens when it exists
it was there and got the warning, so it's OK

NEED TO BE CARFUL ABOUT WHAT WE SAVE IN PREFS - is it the folder where the GH folder lives or is it the GH itself
	does it include the final "/Greenhouse"?
	- IT DOES NOT include the final "Greenhouse".

No need for Greenhouse menu - since saves are automatic.

need to check that the permission check is for the file in the GH/ folder?
	how to do that?
	what if the file doesn't exist? 
	https://docs.oracle.com/javase/7/docs/api/java/security/AccessController.html
	https://docs.oracle.com/javase/7/docs/api/java/io/FilePermission.html
	
5/10/17
this is getting too much of a pain (dealing with folded protein archive etc)
on mac, just use ~/Library/Application Support/Aipotu/Greenhouse
	on startup, check to see if ~/Library/App support exists
		if yes, load GH & FPA from there
		if no, load GH & FPA from inside .app and immediately save both to ~/Library
no need for the GreenhouseDirectoryManager - it's simple enough to build into MGX
	just put the greenhouseDirectory in MGEPreferences
put a notice in the help that that's where the GH is.

Almost working - it doesn't seem to save (always) to the new GH?
may be a thread thing - need to wait for loading to complete before you can save
	added code to wait for the greenhouseLoader to finish - then it hangs...
	
5/11/17
testing git from home

wait to save until needed - that avoids thread issue (it wasn't finished loading before we were trying to save it)
and, if you open but don't save any to GH, the GH isn't being saved
	try putting in quit code - all works except apple-Q
	http://stackoverflow.com/questions/2061194/swing-on-osx-how-to-trap-command-q
	added 		Application.getApplication().setQuitStrategy(QuitStrategy.CLOSE_ALL_WINDOWS);
	seems OK

5/17/17
testing from new laptop - some problems - still trying